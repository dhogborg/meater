#/bin/bash

# Download the image from the server
curl $URL -o /tmp/meater.jpg > /dev/null 2>&1

# transform it to extract the numbers from this particular image
convert /tmp/meater.jpg -rotate -5.8 -crop 100x22+311+206 -modulate 100,0 -level 25%,70% /tmp/crop.jpg 

# translate the image to numbers with gosser
gosser -i /tmp/crop.jpg -p 7 -o int --pedantic --div 1000 --manifest config/manifest.json > /tmp/result 2>&1

if [ $? -eq 0 ]; then
	# insert into influxdb
	result=`cat /tmp/result`
	curl -i -XPOST 'http://influxdb:8086/write?db=meater' --data-binary "meterreading,type=heating,unit=MWh value=$result" > /dev/null 2>&1
fi

result=`cat /tmp/result`
echo "$(date): $result"